# 測試郵件發送功能指南

## 前置準備

### 1. 執行 SQL 腳本
在 Supabase SQL Editor 中執行：
```sql
-- 執行 sqlbak/add-must-change-password.sql
ALTER TABLE user_profiles
  ADD COLUMN IF NOT EXISTS must_change_password BOOLEAN DEFAULT false;

UPDATE user_profiles
SET must_change_password = false
WHERE must_change_password IS NULL;
```

### 2. 確認 Supabase 郵件配置
- 前往 Supabase Dashboard > Settings > Auth > SMTP Settings
- 確認已配置 SMTP 服務（如 Gmail、SendGrid、AWS SES 等）

## 測試步驟

### 測試 1：新增員工（有 email）

1. **登入系統**
   - 使用管理員帳號登入
   - 前往「員工管理」頁面

2. **新增員工**
   - 點擊「新增員工」
   - 填寫必填欄位：
     - 所屬公司：選擇一個公司
     - 部門：選擇一個部門
     - 職位：選擇一個職位
     - 登入名稱：系統會自動生成（或手動輸入，格式：UUA01001）
     - 電子郵件：輸入測試用的 email 地址
     - 姓名：輸入員工姓名
   - 點擊「儲存」

3. **檢查結果**
   - 系統會自動生成隨機8位元密碼
   - 如果郵件發送成功，會顯示「登入資訊已發送至：[email]」
   - 如果郵件發送失敗，會顯示密碼供手動告知

4. **檢查郵件**
   - 檢查測試 email 的收件匣
   - 應該收到包含以下資訊的郵件：
     - 登入網址
     - 登入名稱
     - 初始密碼

### 測試 2：新增員工（無 email）

1. **新增員工（不填寫 email）**
   - 點擊「新增員工」
   - 填寫必填欄位（除了 email）
   - 點擊「儲存」

2. **檢查結果**
   - 系統會顯示生成的密碼
   - 詢問是否要發送登入資訊至您的 email
   - 選擇「確定」後，輸入管理員 email
   - 系統會嘗試發送郵件

### 測試 3：首次登入強制修改密碼

1. **使用新創建的員工帳號登入**
   - 前往登入頁面
   - 輸入登入名稱和初始密碼
   - 點擊「登入」

2. **檢查強制修改密碼**
   - 登入成功後，應該自動跳轉到「修改密碼」頁面
   - 頁面會顯示「首次登入，請修改密碼」

3. **修改密碼**
   - 輸入新密碼（8-20位元，包含大寫、小寫、符號）
   - 確認新密碼
   - 點擊「確認修改」

4. **驗證密碼規則**
   - 測試不符合規則的密碼：
     - 少於8位元：應該顯示錯誤
     - 超過20位元：應該顯示錯誤
     - 沒有大寫字母：應該顯示錯誤
     - 沒有小寫字母：應該顯示錯誤
     - 沒有符號：應該顯示錯誤
     - 包含底線(_)：應該顯示錯誤
     - 包含斜線(/)：應該顯示錯誤
     - 包含反斜線(\)：應該顯示錯誤

5. **完成修改**
   - 輸入符合規則的密碼
   - 修改成功後，應該跳轉到 Dashboard
   - 再次登入時，不應該再要求修改密碼

## 郵件發送配置選項

### 選項 1：使用 Supabase Edge Functions（推薦）

1. 在 Supabase Dashboard 中創建 Edge Function
2. 使用第三方郵件服務（如 Resend、SendGrid）發送郵件
3. 修改 `app/api/send-credentials/route.ts` 調用 Edge Function

### 選項 2：使用 Supabase SMTP 配置

1. 在 Supabase Dashboard > Settings > Auth > SMTP Settings 配置 SMTP
2. 在 Settings > Auth > Email Templates 自定義郵件模板
3. 使用 Supabase 的郵件 API 發送

### 選項 3：使用第三方郵件服務（Next.js API）

1. 安裝郵件服務套件（如 `@resend/node`、`nodemailer`）
2. 在 `app/api/send-credentials/route.ts` 中直接調用郵件服務
3. 配置環境變數（API Key）

## 故障排除

### 問題 1：郵件未發送
- 檢查 Supabase SMTP 配置是否正確
- 檢查 email 地址是否有效
- 查看瀏覽器控制台是否有錯誤訊息
- 檢查 Supabase Dashboard > Logs 中的錯誤

### 問題 2：郵件發送失敗
- 確認 SMTP 服務的 API Key 或密碼正確
- 檢查郵件服務的發送限制
- 確認收件人 email 地址格式正確

### 問題 3：強制修改密碼未生效
- 確認已執行 SQL 腳本添加 `must_change_password` 欄位
- 檢查 `user_profiles` 表中的 `must_change_password` 值是否為 `true`
- 查看瀏覽器控制台是否有錯誤

## 測試檢查清單

- [ ] SQL 腳本已執行
- [ ] Supabase SMTP 已配置（或使用其他郵件服務）
- [ ] 新增員工（有 email）功能正常
- [ ] 新增員工（無 email）功能正常
- [ ] 郵件發送成功
- [ ] 首次登入強制修改密碼功能正常
- [ ] 密碼規則驗證正常
- [ ] 修改密碼後可以正常登入
