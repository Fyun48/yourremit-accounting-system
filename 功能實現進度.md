# 功能實現進度報告

## 📅 更新日期
2026年1月

## ✅ 已完成項目

### 1. 資料庫結構擴展 ✅
- **檔案**: `database-extensions.sql`
- **狀態**: 已完成
- **內容**:
  - ✅ 常用分錄樣板表（journal_entry_templates）
  - ✅ 應收帳款相關表（customers, sales_invoices, invoice_payments）
  - ✅ 應付帳款相關表（vendors, purchase_invoices, vendor_payments, payment_schedules）
  - ✅ 信託專戶表（trust_accounts, remittance_transactions）
  - ✅ 銀行調節表（bank_accounts, bank_statements, bank_statement_items）
  - ✅ 日結功能表（daily_closings）
  - ✅ 匯兌損益重評價表（fx_revaluations）
  - ✅ 所有索引和觸發器
  - ✅ RLS 安全政策

### 2. TypeScript 類型定義 ✅
- **檔案**: `types/index.ts`
- **狀態**: 已完成
- **內容**: 所有新功能的 TypeScript 介面定義

### 3. 導航選單更新 ✅
- **檔案**: `app/dashboard/layout.tsx`
- **狀態**: 已完成
- **新增路由**:
  - ✅ 信託專戶 (`/dashboard/trust-accounts`)
  - ✅ 匯款交易 (`/dashboard/remittances`)
  - ✅ 應收帳款 (`/dashboard/receivables`)
  - ✅ 應付帳款 (`/dashboard/payables`)
  - ✅ 日結作業 (`/dashboard/daily-closing`)

### 4. 信託專戶管理頁面 ✅
- **檔案**: `app/dashboard/trust-accounts/page.tsx`
- **狀態**: 已完成
- **功能**:
  - ✅ 專戶列表顯示
  - ✅ 新增/編輯/刪除專戶
  - ✅ 搜尋和篩選
  - ✅ 統計卡片（總專戶數、客戶信託、公司自有）
  - ✅ 專戶類型區分（公司自有 vs 客戶信託）

## 🚧 待實現功能（按優先順序）

### 高優先級（核心業務功能）

#### 1. 匯款交易管理 ⏳
- **路徑**: `app/dashboard/remittances/page.tsx`
- **功能需求**:
  - [ ] 匯款交易列表
  - [ ] 新增匯款交易（包含手續費分離）
  - [ ] 自動生成會計分錄
  - [ ] 交易狀態管理（待處理、已收款、已匯出）
  - [ ] 與信託專戶關聯
  - [ ] 手續費收入認列

#### 2. 日結作業 ⏳
- **路徑**: `app/dashboard/daily-closing/page.tsx`
- **功能需求**:
  - [ ] 日結表單（選擇日期）
  - [ ] 自動計算當日數據：
    - 今日總收款（TWD）
    - 今日總匯出（外幣）
    - 今日手續費收入
    - 專戶餘額核對
    - 公司帳戶餘額
  - [ ] 生成日結傳票
  - [ ] 日結報表顯示
  - [ ] 日結歷史記錄

#### 3. 信託水位報表 ⏳
- **路徑**: `app/dashboard/trust-accounts/report/page.tsx` 或整合到主頁面
- **功能需求**:
  - [ ] 顯示各專戶餘額
  - [ ] 計算總信託資金
  - [ ] 計算公司自有資金
  - [ ] 餘額預警（不足或過多）
  - [ ] 歷史趨勢圖表

#### 4. 常用分錄樣板 ⏳
- **路徑**: `app/dashboard/journal/templates/page.tsx` 或整合到會計分錄頁面
- **功能需求**:
  - [ ] 樣板列表
  - [ ] 新增/編輯/刪除樣板
  - [ ] 樣板分類管理
  - [ ] 從樣板建立分錄（可修改金額和日期）
  - [ ] 變數支援（如房租金額）

### 中優先級（重要功能）

#### 5. 應收帳款管理 ⏳
- **路徑**: `app/dashboard/receivables/page.tsx`
- **功能需求**:
  - [ ] 客戶資料管理
  - [ ] 銷貨發票管理
  - [ ] 帳齡分析報表（30天、60天、90天以上）
  - [ ] 發票收款（沖帳功能）
  - [ ] 收款記錄查詢

#### 6. 應付帳款管理 ⏳
- **路徑**: `app/dashboard/payables/page.tsx`
- **功能需求**:
  - [ ] 廠商資料管理
  - [ ] 進貨發票管理
  - [ ] 付款排程管理
  - [ ] 付款記錄
  - [ ] 到期提醒

#### 7. 銀行調節表 ⏳
- **路徑**: `app/dashboard/bank-reconciliation/page.tsx`
- **功能需求**:
  - [ ] 銀行帳戶管理
  - [ ] 銀行對帳單匯入（手動輸入或 CSV）
  - [ ] 自動比對功能
  - [ ] 未達帳項管理
  - [ ] 調節表報表

#### 8. 匯兌損益自動重評價 ⏳
- **路徑**: `app/dashboard/fx-revaluation/page.tsx`
- **功能需求**:
  - [ ] 選擇重評價日期和幣別
  - [ ] 自動計算帳面價值
  - [ ] 自動計算市價價值
  - [ ] 計算未實現損益
  - [ ] 生成重評價傳票
  - [ ] 重評價歷史記錄

### 低優先級（便利功能）

#### 9. 稅務申報功能 ⏳
- **路徑**: `app/dashboard/tax-reporting/page.tsx`
- **功能需求**:
  - [ ] 媒體申報檔生成（401/403）
  - [ ] 申報資料匯出
  - [ ] 申報歷史記錄

## 📋 實現建議

### 階段一：核心業務功能（1-2週）
1. 匯款交易管理
2. 日結作業
3. 信託水位報表

### 階段二：會計基礎功能（1週）
4. 常用分錄樣板
5. 應收帳款管理
6. 應付帳款管理

### 階段三：進階功能（1週）
7. 銀行調節表
8. 匯兌損益重評價

### 階段四：稅務功能（3-5天）
9. 稅務申報功能

## 🔧 技術實現要點

### 1. 匯款交易自動分錄邏輯
```typescript
// 當匯款交易完成時，自動生成分錄：
// 借：銀行存款(專戶) - 總金額
// 貸：代付款項 - 匯款金額（本金）
// 貸：手續費收入 - 手續費
// 貸：銷項稅額 - 手續費的稅額
```

### 2. 日結自動計算邏輯
```typescript
// 從 remittance_transactions 表查詢當日交易
// 彙總：
// - total_receipts_twd: SUM(remittance_amount + service_fee) WHERE from_currency = 'TWD'
// - total_remittances: SUM(remitted_amount) WHERE status = '已匯出'
// - total_service_fees: SUM(service_fee)
// - trust_account_balance: 從會計科目計算
```

### 3. 信託水位計算
```typescript
// 從 trust_accounts 和 journal_entry_lines 計算
// 查詢所有「客戶信託」類型的專戶對應的會計科目餘額
// 顯示總信託資金 vs 應付代付款項
```

### 4. 帳齡分析計算
```typescript
// 從 sales_invoices 表計算
// 根據 invoice_date 和 due_date 計算帳齡
// 分組：0-30天、31-60天、61-90天、90天以上
```

## 📝 注意事項

1. **資料庫執行順序**：
   - 先執行 `database-setup.sql`
   - 再執行 `database-extensions.sql`

2. **權限控制**：
   - 所有新表都已設置 RLS
   - 目前政策為所有已認證用戶可管理
   - 後續可根據需求調整權限

3. **會計科目**：
   - 已在 `database-extensions.sql` 中插入信託專戶相關科目
   - 使用時需確保科目存在

4. **測試建議**：
   - 每個功能實現後進行單元測試
   - 測試會計分錄自動生成邏輯
   - 測試日結計算準確性

## 🎯 下一步行動

1. ✅ 執行 `database-extensions.sql` 建立新表
2. ⏳ 實現匯款交易管理頁面
3. ⏳ 實現日結作業頁面
4. ⏳ 實現信託水位報表
5. ⏳ 實現常用分錄樣板功能

---

**當前進度**: 約 30% 完成
**預計完成時間**: 2-3 週（全職開發）

