# 外匯會計與人力資源管理系統 - 完整功能說明

## 目錄

1. [系統概述](#系統概述)
2. [帳號與登入管理](#帳號與登入管理)
3. [會計財務模組](#會計財務模組)
4. [人力資源管理模組](#人力資源管理模組)
5. [權限管理](#權限管理)
6. [公司與員工管理](#公司與員工管理)
7. [系統設定](#系統設定)

---

## 系統概述

本系統是一個整合外匯會計與人力資源管理的綜合性平台，提供完整的財務記帳、匯兌管理、員工管理、出缺勤管理、薪資計算等功能。

### 主要特色

- **完整的會計功能**：支援多幣別交易、會計分錄、財務報表
- **人力資源管理**：打卡、請假、薪資計算、出缺勤報表
- **權限控制**：多層級角色權限與個人特殊權限
- **審核流程**：統一的審核機制，支援多種申請類型
- **報表匯出**：支援 Excel 格式匯出
- **符合法規**：遲到扣款規則符合台灣勞基法

---

## 帳號與登入管理

### 登入功能

**路徑**：`/` (首頁)

**功能說明**：
- 使用登入名稱（非電子郵件）進行登入
- 支援忘記密碼功能
- 已移除註冊功能（需由管理員創建帳號）

**登入名稱格式**：
- 格式：`[小寫字母][6位數字]`
- 範例：`a123456`, `b789012`
- 系統會自動驗證格式

**密碼規則**：
- 至少 8 位數
- 必須包含至少 1 個大寫字母
- 必須包含至少 1 個小寫字母
- 必須包含至少 1 個數字
- 必須包含至少 1 個符號（如：!@#$%^&*等）
- 可啟用 2 段式驗證（在員工資料中設定）

**忘記密碼功能**：
1. 點擊登入頁面的「忘記密碼？」連結
2. 輸入申請帳號時使用的電子郵件地址
3. 系統會發送密碼重置郵件到該信箱
4. 點擊郵件中的連結，進入密碼重置頁面
5. 設定新密碼（需符合密碼規則）

**密碼重置頁面**：
- 路徑：`/reset-password`
- 顯示密碼強度檢查（即時驗證）
- 確認密碼一致性檢查

---

## 會計財務模組

### 1. 儀表板 (`/dashboard`)

**功能**：
- 顯示本月交易統計
- 最近交易記錄
- 當前匯率資訊
- 財務概覽

### 2. 外匯交易 (`/dashboard/transactions`)

**功能**：
- 記錄外匯買入、賣出、兌換交易
- 自動計算匯率與金額
- 支援多幣別（TWD, USD, EUR, JPY等）
- 交易狀態管理（待處理、已完成、已取消）

### 3. 會計分錄 (`/dashboard/journal`)

**功能**：
- 創建會計分錄
- 借方貸方自動平衡檢查
- 支援多幣別分錄
- 分錄狀態管理（草稿、已過帳、已作廢）
- 常用分錄樣板功能

### 4. 流水帳 (`/dashboard/cashbook`)

**功能**：
- 查看現金流水記錄
- 按日期篩選
- 收支統計

### 5. 總分類帳 (`/dashboard/ledger`)

**功能**：
- 查看各會計科目的總分類帳
- 期初餘額、本期發生額、期末餘額
- 支援多幣別

### 6. 試算表 (`/dashboard/trial-balance`)

**功能**：
- 生成試算表
- 檢查借貸平衡
- 按期間查詢

### 7. 財務報表 (`/dashboard/reports`)

**功能**：
- 資產負債表
- 損益表
- 現金流量表
- 支援匯出 Excel

### 8. 信託專戶 (`/dashboard/trust-accounts`)

**功能**：
- 管理信託專戶
- 專戶餘額查詢
- 專戶交易記錄

### 9. 匯款交易 (`/dashboard/remittances`)

**功能**：
- 記錄匯款交易
- 計算手續費
- 匯率轉換
- 交易狀態追蹤

### 10. 應收帳款 (`/dashboard/receivables`)

**功能**：
- 客戶資料管理
- 銷貨發票管理
- 收款記錄
- 應收帳款追蹤

### 11. 應付帳款 (`/dashboard/payables`)

**功能**：
- 廠商資料管理
- 進貨發票管理
- 付款記錄
- 應付帳款追蹤
- 付款排程

### 12. 日結作業 (`/dashboard/daily-closing`)

**功能**：
- 每日結帳作業
- 自動計算當日收支
- 生成日結傳票
- 結帳狀態管理

---

## 人力資源管理模組

### 1. 權限管理 (`/dashboard/permissions`)

**功能**：
- 功能權限列表管理
- 為特定用戶授予特殊權限
- 權限到期日設定
- 權限撤銷功能

**使用對象**：系統管理員

### 2. 公司管理 (`/dashboard/companies`)

**功能**：
- 公司行號登記（類似會計帳的廠商登記）
- 公司基本資料管理
- 統一編號、登記字號管理
- 公司類型設定（有限公司、股份有限公司等）
- 聯絡資訊管理

**欄位**：
- 公司代碼（必填）
- 公司名稱（必填）
- 英文名稱
- 統一編號
- 登記字號
- 公司類型
- 聯絡人、電話、電子郵件
- 地址
- 備註

**使用對象**：系統管理員

### 3. 員工管理 (`/dashboard/employees`)

**功能**：
- 完整的員工個人資料管理
- 登入名稱設定（小寫字母+6位數字）
- 所屬公司選擇（從已登記的公司中選擇）
- 員工編號管理
- 聯絡資料管理
- 銀行資料管理
- 工作資料管理
- 打卡開關設定
- 2段式驗證開關

**員工資料欄位**：

**基本資料**：
- 登入名稱（格式：小寫字母+6位數字）
- 電子郵件
- 姓名
- 員工編號
- 身分證字號
- 所屬公司（從公司列表中選擇）

**聯絡資料**：
- 電話
- 手機
- 地址
- 緊急聯絡人
- 緊急聯絡電話

**銀行資料**：
- 銀行名稱
- 銀行帳號
- 戶名

**工作資料**：
- 部門
- 角色
- 到職日期
- 離職日期
- 是否需要打卡（開關）
- 是否啟用2段式驗證（開關）
- 帳號啟用狀態

**使用對象**：系統管理員

### 4. 打卡管理 (`/dashboard/attendance`)

**功能**：
- 員工上下班打卡
- 自動計算工作時數和加班時數
- 自動判斷遲到、早退狀態
- 自動計算遲到扣款（根據設定的扣款規則）
- 管理員可設定工作時間（上班時間、午休時間、下班時間）

**打卡流程**：
1. 員工點擊「上班打卡」
2. 系統自動記錄打卡時間
3. 系統判斷是否遲到
4. 如果遲到，根據設定的扣款規則自動計算扣款金額
5. 員工點擊「下班打卡」
6. 系統自動計算工作時數和加班時數

**工作時間設定**（管理員）：
- 可創建多個工作時間配置
- 可設定為預設配置
- 支援自訂上班時間、午休時間、下班時間

**打卡限制**：
- 只有 `requires_attendance = true` 的員工需要打卡
- 不需要打卡的員工無法使用打卡功能

**使用對象**：所有需要打卡的員工、系統管理員（設定工作時間）

### 5. 遲到扣款設定 (`/dashboard/late-deduction`)

**功能**：
- 設定符合台灣勞基法的遲到扣款規則
- 支援3種扣款方式：
  1. **固定金額扣款**：每遲到1分鐘扣固定金額
  2. **比例扣款**：按日薪比例扣款，遲到時間佔工作時間的比例
  3. **階梯式扣款**：根據遲到時間區間設定不同扣款金額

**扣款規則設定**：

**規則1：固定金額扣款**
- 每遲到1分鐘扣固定金額（例如：10元）
- 可設定最大扣款金額上限
- 範例：遲到30分鐘，每分鐘扣10元，最多扣500元

**規則2：比例扣款**
- 按日薪比例扣款
- 遲到時間佔工作時間的比例
- 可設定最大扣款金額上限
- 範例：遲到30分鐘（工作時間480分鐘），扣日薪的6.25%，最多扣日薪的10%

**規則3：階梯式扣款**
- 根據遲到時間區間設定不同扣款金額
- 範例：
  - 1-15分鐘：扣50元
  - 16-30分鐘：扣100元
  - 31-60分鐘：扣200元
  - 超過60分鐘：扣500元

**規則應用**：
- 可為不同員工設定不同的扣款規則
- 可設定規則生效日期和到期日期
- 打卡時自動根據規則計算扣款金額

**使用對象**：系統管理員

### 6. 請假管理 (`/dashboard/leave`)

**功能**：
- 員工申請請假
- 支援多種請假類型（特休假、病假、事假、婚假、喪假、產假、陪產假等）
- 審核者可以核准或駁回請假申請
- 自動計算請假天數

**請假類型**：
- 特休假（有薪）
- 病假（有薪）
- 事假（無薪）
- 婚假（有薪）
- 喪假（有薪）
- 產假（有薪）
- 陪產假（有薪）
- 無薪假

**請假流程**：
1. 員工填寫請假申請（類型、日期、事由）
2. 系統自動計算請假天數
3. 提交後狀態為「待審核」
4. 審核者（系統管理員或財務經理）可以核准或駁回
5. 核准後狀態變為「已核准」
6. 請假記錄會影響薪資計算

**使用對象**：所有員工（申請）、系統管理員/財務經理（審核）

### 7. 審核流程 (`/dashboard/approvals`)

**功能**：
- 統一的審核流程管理
- 支援多種申請類型（支出憑單、請假申請等）
- 審核者可以查看待審核項目
- 支援核准和駁回操作
- 可填寫駁回原因

**申請類型**：
- 支出憑單
- 請假申請
- 採購單
- 付款申請

**審核流程**：
1. 申請人提交申請
2. 狀態變為「待審核」或「審核中」
3. 審核者可以查看待審核列表
4. 審核者可以核准或駁回
5. 駁回時需填寫原因
6. 核准後狀態變為「已核准」

**使用對象**：系統管理員、財務經理

### 8. 支出憑單 (`/dashboard/expense-vouchers`)

**功能**：
- 員工申請支出憑單
- 支援多個支出項目
- 需要審核後才能付款
- 可以關聯會計科目

**支出憑單流程**：
1. 員工填寫支出憑單（日期、部門、用途、明細項目）
2. 可添加多個支出項目
3. 可選擇會計科目
4. 提交後狀態為「待審核」
5. 審核者可以核准或駁回
6. 核准後可以進行付款

**使用對象**：所有員工（申請）、系統管理員/財務經理（審核）

### 9. 出缺勤報表 (`/dashboard/attendance-reports`)

**功能**：
- 查看月/季/年出缺勤統計
- 支援按員工篩選
- 可以匯出 Excel 報表
- 顯示詳細的統計數據

**報表內容**：
- 總工作天數
- 總工作時數
- 總加班時數
- 遲到次數
- 早退次數
- 缺勤次數
- 請假天數
- 詳細記錄列表（日期、員工、上班時間、下班時間、工作時數、加班時數、狀態）

**期間類型**：
- 月報表
- 季報表
- 年報表

**Excel 匯出**：
- 包含詳細記錄工作表
- 包含統計摘要工作表
- 自動格式化列寬

**使用對象**：系統管理員、財務經理

### 10. 薪資管理 (`/dashboard/payroll`)

**功能**：
- 管理員工薪資結構
- 設定基本薪資和時薪
- 添加薪資加項和減項
- 自動計算薪資（結合出缺勤數據）
- 匯出人事費用成本報表

**薪資結構設定**：
- 基本薪資
- 時薪（用於計算加班費）
- 加項項目（例如：全勤獎金、績效獎金等）
- 減項項目（例如：借支、其他扣款等）
- 生效日期

**薪資計算流程**：
1. 選擇薪資期間（月份）
2. 系統自動讀取：
   - 員工薪資結構
   - 當月出缺勤記錄
   - 請假記錄
   - 勞健保設定
3. 計算：
   - 基本薪資
   - 加項總額（含加班費）
   - 減項總額（含勞健保）
   - 應發薪資
4. 儲存計算結果

**人事費用成本報表**：
- 匯出 Excel 格式
- 包含所有員工的薪資明細
- 各項加項和減項
- 勞健保費用
- 總計行

**使用對象**：系統管理員、財務經理

### 11. 薪資轉帳 (`/dashboard/salary-transfers`)

**功能**：
- 創建薪資轉帳批次
- 批量處理薪資轉帳
- 查看轉帳明細
- 匯出轉帳文件

**轉帳流程**：
1. 選擇薪資期間
2. 點擊「創建轉帳批次」
3. 系統會為該期間所有已確認的薪資計算創建轉帳批次
4. 點擊「處理轉帳」執行轉帳操作
5. 點擊「匯出」下載轉帳明細 Excel 文件

**轉帳狀態**：
- 待處理
- 處理中
- 已完成
- 部分失敗
- 已取消

**使用對象**：系統管理員、財務經理

---

## 權限管理

### 角色權限

系統預設以下角色：

1. **系統管理員**
   - 擁有所有功能的管理權限
   - 可以管理用戶、公司、員工資料
   - 可以設定各種規則和配置

2. **財務經理**
   - 可以審核請假、支出憑單
   - 可以管理薪資和轉帳
   - 可以查看所有財務報表

3. **會計人員**
   - 可以查看和創建交易
   - 可以申請請假和支出憑單
   - 可以查看個人薪資

4. **查詢人員**
   - 只能查看數據
   - 無法進行任何修改操作

### 功能權限

系統支援細粒度的功能權限控制：

- `hrm_attendance`: 打卡功能
- `hrm_attendance_admin`: 打卡管理
- `hrm_leave`: 請假功能
- `hrm_leave_admin`: 請假審核
- `hrm_payroll`: 薪資查看
- `hrm_payroll_admin`: 薪資管理
- `hrm_salary_transfer`: 薪資轉帳
- `expense_voucher`: 支出憑單申請
- `expense_voucher_approve`: 支出憑單審核

管理員可以為特定用戶授予特殊權限，並設定權限到期日。

---

## 公司與員工管理

### 公司管理

**功能位置**：`/dashboard/companies`

**說明**：
- 公司行號登記功能類似會計帳的廠商登記
- 可以登記多個公司
- 員工資料中可以選擇所屬公司
- 方便按公司分組管理員工

**使用場景**：
- 集團公司管理多個子公司
- 外包人員管理
- 合作夥伴管理

### 員工管理

**功能位置**：`/dashboard/employees`

**說明**：
- 完整的員工個人資料管理
- 可以設定員工是否需要打卡
- 可以設定員工所屬公司
- 可以設定登入名稱（格式：小寫字母+6位數字）
- 可以啟用2段式驗證

**員工資料包含**：
- 基本資料（姓名、員工編號、身分證字號等）
- 聯絡資料（電話、地址、緊急聯絡人等）
- 銀行資料（銀行名稱、帳號、戶名）
- 工作資料（部門、角色、到職日期等）
- 系統設定（打卡開關、2段式驗證等）

---

## 系統設定

**功能位置**：`/dashboard/settings`

**功能**：
- 個人資料設定
- 會計科目管理
- 系統參數設定

---

## 數據庫表結構

### 主要數據表

**會計相關**：
- `chart_of_accounts`: 會計科目表
- `forex_transactions`: 外匯交易表
- `journal_entries`: 會計分錄表
- `journal_entry_lines`: 會計分錄明細表
- `exchange_rates`: 匯率表

**人力資源相關**：
- `user_profiles`: 用戶資料表（擴展）
- `companies`: 公司表
- `attendance_records`: 打卡記錄表
- `leave_requests`: 請假申請表
- `employee_salary_structures`: 員工薪資結構表
- `payroll_calculations`: 薪資計算記錄表
- `salary_transfers`: 薪資轉帳記錄表
- `late_deduction_rules`: 遲到扣款規則表
- `work_schedule_configs`: 工作時間設定表

**權限相關**：
- `user_roles`: 用戶角色表
- `feature_permissions`: 功能權限表
- `user_feature_permissions`: 用戶功能權限表

**審核相關**：
- `approval_records`: 審核記錄表
- `approval_step_records`: 審核步驟記錄表
- `expense_vouchers`: 支出憑單表

詳細表結構請參考：
- `database-setup.sql`
- `database-extensions.sql`
- `database-hrm.sql`
- `database-hrm-supplement.sql`

---

## 安裝與設置

### 1. 安裝依賴

```bash
npm install
```

### 2. 數據庫設置

在 Supabase SQL Editor 中按順序執行以下腳本：

1. `database-setup.sql` - 基礎表結構
2. `database-extensions.sql` - 擴展功能
3. `database-hrm.sql` - HRM 模組
4. `database-hrm-supplement.sql` - HRM 補充功能

### 3. 環境變數

確保 `.env.local` 文件中包含：

```
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
```

### 4. 啟動開發服務器

```bash
npm run dev
```

---

## 注意事項

### 登入與帳號

1. **登入名稱格式**：必須為小寫字母+6位數字（例如：a123456）
2. **密碼規則**：必須符合強度要求（至少8位數，包含大寫、小寫、數字、符號）
3. **註冊功能**：已移除，需由管理員創建帳號
4. **忘記密碼**：會發送重置郵件到申請帳號時使用的電子郵件

### 打卡功能

1. **打卡限制**：只有 `requires_attendance = true` 的員工需要打卡
2. **遲到扣款**：系統會根據設定的扣款規則自動計算
3. **工作時間**：管理員可以設定多個工作時間配置

### 薪資計算

1. **薪資結構**：需要先設定員工薪資結構
2. **勞健保**：需要設定勞健保配置
3. **出缺勤整合**：會自動讀取當月出缺勤數據
4. **加班費**：如果有設定時薪，會自動計算加班費

### 公司管理

1. **公司登記**：類似會計帳的廠商登記功能
2. **員工分組**：員工可以選擇所屬公司，方便分組管理

---

## 技術支援

如有問題或建議，請聯繫系統管理員。

---

## 版本資訊

- 系統版本：1.0.0
- 最後更新：2026年
- 開發框架：Next.js 14, React 18, TypeScript
- 數據庫：Supabase (PostgreSQL)
- UI 框架：Tailwind CSS
