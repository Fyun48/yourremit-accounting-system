# 人力資源管理模組功能說明

## 概述

本系統已新增完整的人力資源管理（HRM）模組，包含以下功能：

1. 個人帳戶權限與特殊權限管理
2. 打卡功能（含工作時間設定）
3. 請假功能
4. 審核功能（支出憑單等）
5. 出缺勤報表（月/季/年統計，Excel下載）
6. 薪資結構管理與人事費用成本報表
7. 薪資轉帳功能

## 安裝與設置

### 1. 安裝依賴

```bash
npm install
```

新增的依賴：
- `xlsx`: 用於 Excel 文件導出功能

### 2. 數據庫設置

在 Supabase SQL Editor 中執行以下腳本：

1. 首先執行 `database-setup.sql`（如果尚未執行）
2. 然後執行 `database-hrm.sql` 創建 HRM 相關表結構

### 3. 環境變數

確保 `.env.local` 文件中包含 Supabase 配置：

```
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
```

## 功能詳情

### 1. 權限管理 (`/dashboard/permissions`)

**功能說明：**
- 管理系統功能權限列表
- 為特定用戶授予特殊權限
- 查看所有用戶的權限狀態
- 支援權限到期日設定

**使用方式：**
1. 系統管理員可以查看所有功能權限
2. 點擊「授予權限」按鈕為用戶添加特殊權限
3. 可以設定權限到期日
4. 可以撤銷已授予的權限

### 2. 打卡管理 (`/dashboard/attendance`)

**功能說明：**
- 員工上下班打卡
- 自動計算工作時數和加班時數
- 自動判斷遲到、早退狀態
- 管理員可設定工作時間（上班時間、午休時間、下班時間）

**使用方式：**
1. 員工點擊「上班打卡」和「下班打卡」按鈕
2. 系統自動記錄打卡時間並計算工作時數
3. 管理員可以點擊「工作時間設定」新增或修改工作時間配置

**工作時間設定：**
- 管理員可以創建多個工作時間配置
- 可以設定為預設配置
- 支援自訂上班時間、午休時間、下班時間

### 3. 請假管理 (`/dashboard/leave`)

**功能說明：**
- 員工申請請假
- 支援多種請假類型（特休假、病假、事假等）
- 審核者可以核准或駁回請假申請
- 自動計算請假天數

**使用方式：**
1. 員工點擊「申請請假」填寫請假資訊
2. 選擇請假類型、日期範圍和事由
3. 審核者（系統管理員或財務經理）可以核准或駁回申請
4. 系統自動計算請假天數

**請假類型：**
- 特休假（有薪）
- 病假（有薪）
- 事假（無薪）
- 婚假、喪假、產假、陪產假等

### 4. 審核流程 (`/dashboard/approvals`)

**功能說明：**
- 統一的審核流程管理
- 支援多種申請類型（支出憑單、請假申請等）
- 審核者可以查看待審核項目
- 支援核准和駁回操作

**使用方式：**
1. 審核者可以查看所有待審核的申請
2. 可以按狀態和類型篩選
3. 點擊「核准」或「駁回」進行審核
4. 駁回時需要填寫原因

### 5. 支出憑單 (`/dashboard/expense-vouchers`)

**功能說明：**
- 員工申請支出憑單
- 支援多個支出項目
- 需要審核後才能付款
- 可以關聯會計科目

**使用方式：**
1. 員工點擊「新增支出憑單」
2. 填寫申請日期、部門、用途說明
3. 添加支出明細項目（可多個）
4. 選擇會計科目（選填）
5. 提交後等待審核
6. 審核者可以核准或駁回

### 6. 出缺勤報表 (`/dashboard/attendance-reports`)

**功能說明：**
- 查看月/季/年出缺勤統計
- 支援按員工篩選
- 可以匯出 Excel 報表
- 顯示詳細的統計數據

**使用方式：**
1. 選擇期間類型（月/季/年）
2. 選擇具體期間
3. 可選：選擇特定員工
4. 點擊「查詢」查看報表
5. 點擊「匯出Excel」下載報表

**報表內容：**
- 總工作天數
- 總工作時數
- 總加班時數
- 遲到次數
- 早退次數
- 缺勤次數
- 請假天數
- 詳細記錄列表

### 7. 薪資管理 (`/dashboard/payroll`)

**功能說明：**
- 管理員工薪資結構
- 設定基本薪資和時薪
- 添加薪資加項和減項
- 自動計算薪資（結合出缺勤數據）
- 匯出人事費用成本報表

**使用方式：**

**設定薪資結構：**
1. 管理員點擊「新增薪資結構」
2. 選擇員工
3. 設定基本薪資和時薪
4. 添加薪資項目（加項/減項）
5. 設定生效日期

**計算薪資：**
1. 選擇薪資期間（月份）
2. 系統自動載入該期間已確認的薪資計算記錄
3. 點擊「計算薪資」按鈕
4. 系統會：
   - 讀取員工薪資結構
   - 讀取當月出缺勤記錄
   - 讀取請假記錄
   - 計算加項（含加班費）
   - 計算減項（含勞健保）
   - 計算應發薪資

**匯出報表：**
1. 點擊「匯出報表」按鈕
2. 系統會生成 Excel 文件，包含：
   - 所有員工的薪資明細
   - 各項加項和減項
   - 勞健保費用
   - 總計行

### 8. 薪資轉帳 (`/dashboard/salary-transfers`)

**功能說明：**
- 創建薪資轉帳批次
- 批量處理薪資轉帳
- 查看轉帳明細
- 匯出轉帳文件

**使用方式：**
1. 選擇薪資期間
2. 點擊「創建轉帳批次」
3. 系統會為該期間所有已確認的薪資計算創建轉帳批次
4. 點擊「處理轉帳」執行轉帳操作
5. 點擊「匯出」下載轉帳明細 Excel 文件

**轉帳流程：**
1. 創建轉帳批次（狀態：待處理）
2. 處理轉帳（狀態：處理中）
3. 轉帳完成（狀態：已完成）
4. 如有失敗項目（狀態：部分失敗）

## 權限說明

### 角色權限

- **系統管理員**：擁有所有功能的管理權限
- **財務經理**：可以審核請假、支出憑單，管理薪資和轉帳
- **會計人員**：可以查看和創建交易，申請請假和支出憑單
- **查詢人員**：只能查看數據

### 功能權限

系統支援細粒度的功能權限控制：
- `hrm_attendance`: 打卡功能
- `hrm_attendance_admin`: 打卡管理
- `hrm_leave`: 請假功能
- `hrm_leave_admin`: 請假審核
- `hrm_payroll`: 薪資查看
- `hrm_payroll_admin`: 薪資管理
- `hrm_salary_transfer`: 薪資轉帳
- `expense_voucher`: 支出憑單申請
- `expense_voucher_approve`: 支出憑單審核

## 數據庫表結構

主要數據表：
- `feature_permissions`: 功能權限表
- `user_feature_permissions`: 用戶功能權限表
- `work_schedule_configs`: 工作時間設定表
- `employee_work_schedules`: 員工工作時間設定表
- `attendance_records`: 打卡記錄表
- `leave_types`: 請假類型表
- `leave_requests`: 請假申請表
- `approval_workflows`: 審核流程模板表
- `approval_records`: 審核記錄表
- `expense_vouchers`: 支出憑單表
- `employee_salary_structures`: 員工薪資結構表
- `salary_items`: 薪資項目表
- `insurance_configs`: 勞健保設定表
- `payroll_calculations`: 薪資計算記錄表
- `salary_transfers`: 薪資轉帳記錄表

詳細表結構請參考 `database-hrm.sql` 文件。

## 注意事項

1. **打卡功能**：
   - 系統會自動判斷遲到和早退
   - 工作時數會自動計算
   - 加班時數為超過標準工作時間（8小時）的部分

2. **請假功能**：
   - 請假申請需要審核
   - 系統會自動計算請假天數
   - 請假記錄會影響薪資計算

3. **薪資計算**：
   - 需要先設定員工薪資結構
   - 需要設定勞健保配置
   - 會自動讀取當月出缺勤數據
   - 會自動計算加班費（如果有設定時薪）

4. **薪資轉帳**：
   - 只能為已確認的薪資計算創建轉帳批次
   - 實際轉帳操作需要整合銀行 API（目前為模擬）

5. **Excel 匯出**：
   - 所有報表都支援匯出為 Excel 格式
   - 檔案會自動下載到瀏覽器預設下載位置

## 後續擴展建議

1. **整合銀行 API**：實現實際的薪資轉帳功能
2. **通知功能**：添加審核通知、請假通知等
3. **報表優化**：添加更多圖表和統計分析
4. **移動端支援**：優化移動設備的使用體驗
5. **批量操作**：支援批量審核、批量計算薪資等
6. **歷史記錄**：查看歷史薪資、歷史請假記錄等

## 技術支援

如有問題或建議，請聯繫系統管理員。
